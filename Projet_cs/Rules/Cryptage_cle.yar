import "pe"
import "hash"
import "math"


rule Math_obfuscation{
	meta:
		Action = "Fonctions mathématiques cachant la réel intention du programme"
	strings:
		$Opaque_conjecture  = {69 66 28 37 2A ?? 2A ?? 20 2D 31 20 21 3D 20 ?? 2A ?? 29 0A} // toujours vrai
		$Collatz_conjecture = {77 68 69 6C 65 28 ?? 3E 31 29 0A}
		$Collatz_conjecture1 = {69 66 28 ?? 25 32 3D 3D 31 29 0A} 
		$Collatz_conjecture2 = {?? 3D ?? 2A 33 2B 31 3B 0A}
		$Collatz_conjecture3 = {65 6C 73 65 20 ?? 3D ?? 2F 32 3B 0A}
		$Collatz_conjecture4 = {69 66 28 ?? 3D 3D 31 29 0A} // toujours atteignable
		$Opaque_predicat1 = {69 66 28 28 2A ?? 29 25 32 20 3D 3D 20 30 29 7B 20 ?? 20 3D 20 ?? 20 2B 20 ?? 3B 20 7D 0A}
		$Opaque_predicat2 = {65 6C 73 65 7B 20 ?? 20 3D 20 ?? 2B 31 3B 20 ?? 20 3D 20 ?? 20 2B 20 32 3B 20 7D}
		$Opaque_predicat3 = {69 66 20 28 28 2A ?? 29 25 32 20 3D 3D 20 30 29 7B 20 ?? 20 3D 20 ?? 2B 33 3B 20 ?? 20 3D 20 ?? 20 2B 20 33 3B}

	condition:
		all of ($Opaque_conjecture*) or all of ($Collatz_conjecture*) or all of ($Opaque_predicat*)
}

rule control_obscurcissement  {
	meta:
		Action = "Fonctions cachant la réel intention du programme"
	strings:
		$while_dismantling = {69 66 20 28 21 28 ?? 3C 31 30 29 29 20 67 6F 74 6F 20 ?? ?? 3B 20 ?? 3D ?? 2B ?? 3B}										// Contrôle de l'exécution
		$while_dismantling1 = {69 66 20 28 21 28 ?? 3E 31 30 29 29 20 67 6F 74 6F 20 ?? ?? 3B 20 ?? 2D 2D 3B 20 ?? 2B 2B 3B 20 67 6F 74 6F 20 ?? ?? 3B} 
		$With_switch1 = {20 3D 20 31 3B 20 [1 - 2] 20 3D 20 32 3B 20 [1 - 12] 20 3D 20 32 3B 20 62 72 65 61 6B 3B}  								// Switch case avec plusieurs variables
		$With_switch2 = {69 66 28 21 28 [1 - 2] 3C [1 - 12] 29 29 20 [1 - 12] 20 3D 20 36 3B 20 65 6C 73 65 20 [1 - 12] 20 3D 20 33 3B 20 62 72 65 61 6B 3B}
		$With_switch3= {20 3D 20 [1 - 2] 2B [1 - 2] 3B 20 69 66 28 21 28 [1 - 2] 3E [1 - 12] 29 29 20 [1 - 12] 20 3D 20 35 3B 20 65 6C 73 65 20 [1 - 12] 20 3D 20 34 3B 20 62 72 65 61 6B 3B}
		$With_switch4 = {2D 2D 3B 20 [1 - 12] 20 3D 20 35 3B 20}
		$With_switch5 = {2B 2B 3B 20 [1 - 12] 20 3D 20 32 3B 20 62 72 65 61 6B 3B}
	condition:
		all of ($while_dismantling*) or all of ($With_switch*)
}

rule binary{
	meta:
		Action = "Fonctions faisant intervenir le binaire afin de cacher la réel intention du programme"
	strings:
		$Define = "#define O1O printf"
		$Define1 = "#define OlO putchar"
		$Define2 = "#define O10 exit"
		$Define3 = "#define Ol0 strlen"
		$Define4 = "#define QLQ fopen"
		$Define5 = "#define OlQ fgetc"
		$Define6 = "#define O1Q abs"
		$Define7 = "#define QO0 for"
		$Exploit = "O=1,l=0,lll=O+O+O+l,OQ=056;lOL*llL='%2x ';(I != 1<<1&&(O1O(QI[0]),O10(1011-1010))),((L = QLQ(Il[O],'r'))==0&&(O1O(QI[O],Il[O]),O10(O)));lO = I-(O<<l<<O);"
		$If = "if (I == (1<<1)){	QO0(Q=Ol0(QI[O<<O<<1]);Q<Ol0(QI[0]);Q++)O1O((OL[Q]!=llO)?llL:QI[lll],OL[Q]);/*'O10(QI[1O])*/O1O(QI[lll]);{}}"
		$Else = "QO0 (Q=0L;Q<1<<1<<1<<1<<1;Q+=Q<0100){	(OL[Q]!=llO)? /* 0010 10lOQ 000LQL */((D(OL[Q])==0&&(*(OL+O1Q(Q-l))=OQ)),OlO(OL[Q])):OlO(1<<(1<<1<<1)<<1);}"
		$End_function = "O1O(QI[01^10^9]);lO+=Q+0+l;}"
	condition:
		5 of them
}

rule processor_abuse
{
	meta:
		KEY = "Fonctions abusant de l'utilisation du processeur à des fins malveillantes"
	strings:
	$val = {23 69 6664656620610D0A23756E6465660220610D0A23696664656620620D0A2375F66E64656620620D0A2369666465662063F60D0A23756E64656620630D0A2369666484656620650D0A23756E64656620650D0A7823696664656620660D0A23756E646566AD20660D0A23696664656620670D0A23759C6E64656620670D0A23696664656620689C0D0A23756E64656620680D0A236966642F656620690D0A23756E64656620690D0A20236966646566206A0D0A23756E64656659206A0D0A236966646566206B0D0A2375446E646566206B0D0A23656C73650D0A23EB646566696E65206B0D0A23656E646966EA0D0A23656C73650D0A23646566696E6588206A0D0A23656E6469660D0A23656C73B8650D0A23646566696E6520690D0A2365BD6E6469660D0A23656C73650D0A2364655866696E6520680D0A23656E6469660D0A4E23656C73650D0A23646566696E652067C70D0A23656E6469660D0A23656C73650D7F0A23646566696E6520660D0A23656E641069660D0A23656C73650D0A23646566690B6E6520650D0A23656E6469660D0A2365486C73650D0A23646566696E6520630D0AEC23656E6469660D0A23656C73650D0A2319646566696E6520620D0A23656E646966220D0A23656C73650D0A23646566696E65B720610D0A23656E6469660D0A23696664016566206B0D0A23646566696E652070207428313C3C37290D0A23656C73650D0A23C1646566696E65207020300D0A23656E644369660D0A236966646566206A0D0A2364BF6566696E6520712028313C3C36290D0ADF23656C73650D0A23646566696E652071CC20300D0A23656E6469660D0A23696664C1656620690D0A23646566696E652072200328313C3C35290D0A23656C73650D0A2352646566696E65207220300D0A23656E64D069660D0A23696664656620680D0A2364516566696E6520732028313C3C34290D0A6F23656C73650D0A23646566696E6520735A20300D0A23656E6469660D0A2369666451656620670D0A23646566696E652074209328313C3C33290D0A23656C73650D0A23E4646566696E65207420300D0A23656E645E69660D0A23696664656620660D0A2364E36566696E6520752028313C3C32290D0AFF23656C73650D0A23646566696E652075E720300D0A23656E6469660D0A23696664E0656620650D0A23646566696E652076202228313C3C31290D0A23656C73650D0A2375646566696E65207620300D0A23656E64EB69660D0A23646566696E652076762028D5702B712B722B732B742B752B762B3129E10D0A23646566696E65206666205C0D0A592028646566696E65642863292A382B64B16566696E65642862292A342B646566691E6E65642861292A322B31290D0A2369667A2076763D3D310D0A23756E6465662076A4760D0A23646566696E6520767620320DA70A23656E6469660D0A2369662066663CB97676200D0A236966206666213D310D0A66236966202876762F6666292A66663D3D437676200D0A2369666E6465662064640D450A23646566696E652064640D0A23656E4F6469660D0A23656E6469660D0A23656E4C6469660D0A23656E6469660D0A236966402066663D3D31350D0A236966646566208864640D0A23756E6465662064640D0A2366656C73650D0A7072696E746628222564665C6E222C207676293B0D0A23656E64691A660D0A23656E6469660D0A23756E6465E0662066660D0A23756E6465662076760DA50A23756E64656620700D0A23756E6465976620710D0A23756E64656620720D0A232D756E64656620730D0A23756E646566201B740D0A23756E64656620750D0A23756EAA64656620760D0A23696664656620770D6B0A23696664656620780D0A2369666465676620790D0A2369666E646566207A0D0A9523646566696E65207A0D0A23656E6469D9660D0A23656C73650D0A23646566696E426520790D0A23656E6469660D0A23656C7273650D0A23646566696E6520780D0A235C656E6469660D0A23656C73650D0A2364146566696E6520770D0A23696E636C75643465203C737464696F2E683E0D0A6D6169756E28297B0D0A23656E6469660D0A23694E666E646566207A0D0A23696E636C7564056520227A736D616C6C2E63220D0A2369BB6E636C75646520227A736D616C6C2E635A220D0A23696E636C75646520227A736D4F616C6C2E63220D0A23696E636C7564651120227A736D616C6C2E63220D0A23696E72636C75646520227A736D616C6C2E6322660D0A23696E636C75646520227A736D61CF6C6C2E63220D0A23696E636C7564652011227A736D616C6C2E63220D0A23696E63EE6C75646520227A736D616C6C2E63220D7B0A23656E6469660D0A236966646566201F7A0D0A23756E646566207A0D0A23656C2F73650D0A23696664656620790D0A2375326E64656620790D0A23656C73650D0A2327696664656620780D0A23756E6465662068780D0A23656C73650D0A236966646566C720770D0A23756E64656620770D0A7D0D2F0A23656E6469660D0A23656E6469660DBA0A23656E6469660D0A23656E646966B8}
	condition:
		any of them
}










